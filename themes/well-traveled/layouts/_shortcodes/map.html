<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<div id="map-{{ .Get "id" }}" style="height: {{ .Get "height" | default "500px" }}; width: 100%;"></div>

<script>
(function() {
  const mapId = "map-{{ .Get "id" }}";
  const map = L.map(mapId).setView([{{ .Get "lat" | default 0 }}, {{ .Get "lng" | default 0 }}], {{ .Get "zoom" | default 13 }});

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: 'Â© OpenStreetMap'
  }).addTo(map);

  const boundsGroup = L.featureGroup().addTo(map);

const iconConfig = {
  // --- Dining & Lodging (Orange/Blue) ---
  cafe: { color: "#e67e22", icon: "fa-coffee" },
  restaurant: { color: "#d35400", icon: "fa-utensils" },
  hotel: { color: "#2980b9", icon: "fa-bed" },
  ryokan: { color: "#5d4037", icon: "fa-house-user" }, // Free alternative
  onsen: { color: "#3498db", icon: "fa-hot-tub" },     // Free alternative

  // --- Transport (Navy/Teal) ---
  station: { color: "#34495e", icon: "fa-train" },
  airport: { color: "#2c3e50", icon: "fa-plane" },
  cable_car: { color: "#7f8c8d", icon: "fa-cable-car" }, // FA6 Free
  ferry: { color: "#16a085", icon: "fa-ship" },
  boat: { color: "#1abc9c", icon: "fa-anchor" },

  // --- Culture & History (Red/Gold/Grey) ---
  shinto_shrines: { color: "#e74c3c", icon: "fa-torii-gate" }, // Best free Torii proxy
  buddhist_temples: { color: "#f39c12", icon: "fa-vihara" },      // Universal spiritual icon
  palace: { color: "#8e44ad", icon: "fa-landmark" },
  castle: { color: "#2c3e50", icon: "fa-fort-awesome" },     // Free Brand icon
  memorial: { color: "#95a5a6", icon: "fa-monument" },
  landmark: { color: "#c0392b", icon: "fa-map-pin" },
  museum: { color: "#7f8c8d", icon: "fa-building-columns" },

  // --- Nature (Greens) ---
  garden: { color: "#27ae60", icon: "fa-leaf" },
  forest: { color: "#1b5e20", icon: "fa-tree" },
  park: { color: "#2ecc71", icon: "fa-tree" },
  bamboo: { color: "#00c853", icon: "fa-barcode" },    // Visual proxy for stalks
  lake: { color: "#3498db", icon: "fa-water" },
  sakura: { color: "#ffc0cb", icon: "fa-clover" },           // Floral proxy
  deer: { color: "#8d6e63", icon: "fa-paw" },

  // --- Misc/Sightseeing (Purple/Yellow) ---
  observation_tower: { color: "#16a085", icon: "fa-tower-observation" }, // FA6 Free
  shops: { color: "#9b59b6", icon: "fa-bag-shopping" },
  market: { color: "#8e44ad", icon: "fa-basket-shopping" },

  // --- Default ---
  default: { color: "#7f8c8d", icon: "fa-location-dot" }
};

const createFontAwesomeIcon = (type) => {
  const config = iconConfig[type] || iconConfig.default;
  
  return L.divIcon({
    html: `<div style="display: flex; justify-content: center; align-items: center; width: 30px; height: 30px; background-color: ${config.color}; border-radius: 50% 50% 50% 0; transform: rotate(-45deg); border: 2px solid white; box-shadow: 0 0 4px rgba(0,0,0,0.4);">
             <i class="fa-solid ${config.icon}" style="transform: rotate(45deg); color: white; font-size: 14px;"></i>
           </div>`,
    className: 'custom-div-icon', // Removes default Leaflet styling
    iconSize: [30, 30],
    iconAnchor: [15, 30],
    popupAnchor: [0, -30]
  });
};

  // Helper to add markers and update view
  const addMarker = (m) => {
    if (m.lat && m.lng) {
      const icon = createFontAwesomeIcon(m.type);
      const marker = L.marker([m.lat, m.lng], { icon: icon }).addTo(map);
      
      if (m.popup) marker.bindPopup(m.popup);
      boundsGroup.addLayer(marker);
    }
  };

  // 1. Process Inline Markers
  {{ with .Get "markers" }}
    const inlineMarkers = {{ . | safeJS }}; 
    if (Array.isArray(inlineMarkers)) {
      inlineMarkers.forEach(addMarker);
    }
  {{ end }}

  // 2. Process External File
  {{ with .Get "markersFile" }}
    fetch({{ . }})
      .then(res => res.json())
      .then(data => {
        data.forEach(addMarker);
        // Fit bounds after external data is in
        if (boundsGroup.getLayers().length > 0) {
          map.fitBounds(boundsGroup.getBounds(), { padding: [30, 30] });
        }
      })
      .catch(err => console.error("Map Error:", err));
  {{ end }}

  // Initial fit for inline markers (if no external file is used)
  {{ if not (.Get "markersFile") }}
    if (boundsGroup.getLayers().length > 0) {
      map.fitBounds(boundsGroup.getBounds(), { padding: [30, 30] });
    }
  {{ end }}
})();
</script>